# Docker Compose configuration for the config-store application
# Defines services (containers), networks, and volumes needed to run the app

services:
  # Application service - Node.js API server
  app:
    # Build configuration - tells Docker how to build the app image
    build:
      context: .  # Use current directory as build context (where Dockerfile is located)
      target: development  # Build the 'development' stage from multi-stage Dockerfile
    # Port mapping - maps container port to host port
    # Format: "host_port:container_port"
    # Access the app at http://localhost:3000 (container runs on port 80)
    ports:
      - 3000:80
    # Environment variables passed to the container
    environment:
      - PORT=80  # Port the application listens on inside the container
      # Database connection URL using environment variables and service name 'db'
      # Format: postgresql://user:password@host:port/database
      # 'db' is the service name, automatically resolved by Docker Compose networking
      - DB_URL=postgresql://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_NAME}
    # Development mode configuration - enables hot-reload/watch mode
    develop:
      watch:
        # Sync local source code changes to container in real-time
        - action: sync
          path: ./src  # Local source directory to watch
          target: /app/src  # Destination path inside container
    # Service dependencies - ensures 'db' service starts before 'app'
    depends_on:
      - db  
    # Network configuration - connects app to the shared network
    networks:
      - config-store-net
  # PostgreSQL database service
  db:
    # Use official PostgreSQL Docker image (version 17.1)
    # This image automatically sets up PostgreSQL when the container starts
    image: postgres:17.1
    # Environment variables for PostgreSQL initialization
    # These are only used on first startup to create the database and user
    environment:
      - POSTGRES_USER=${DB_USER}        # Database user (from .env file)
      - POSTGRES_PASSWORD=${DB_PASSWORD} # Database password (from .env file)
      - POSTGRES_DB=${DB_NAME}          # Database name (from .env file)
    # Volume mounting - persists database data outside the container
    # This ensures data survives container restarts and deletions
    volumes:
      - type: volume
        source: postgres-data  # Named volume (defined below)
        target: /var/lib/postgresql/data  # PostgreSQL data directory inside container
    # Network configuration - connects db to the shared network
    # Allows 'app' service to communicate with 'db' service by hostname
    networks:
      config-store-net:

# Network definitions
# Creates an isolated network for services to communicate
networks:
  config-store-net:
    # All services on this network can reach each other by service name
    # Example: 'app' can connect to 'db' using hostname 'db'

# Volume definitions
# Named volumes persist data outside containers
volumes:
  postgres-data:
    # This volume stores PostgreSQL database files
    # Managed by Docker - persists even if containers are removed
    # Location: Docker's internal volume storage (var/lib/docker/volumes/)